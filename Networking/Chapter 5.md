# Chapter 5 传输层

应用层 HTTP HTTPS FTP DNS SMTP PoP3 RDP

传输层 TCP UDP

网络层 IP（RIP，OSPF，BGP）ICMP IGMP ARP

## TCP

- 分段
- 编号
- 流量控制
- 建立会话

## UDP

- 一个数据包就能完成数据通信
- 不建立会话
- 多播

## 传输层和应用层之间的关系

http=TCP+80

https=TCP+443

ftp=TCP+21

SMTP=TCP+25

POP3=TCP+110

RDP=TCP+3389

SQL=TCP+1433

DNS=UDP+53 or TCP+53

## 应用层协议和服务的关系

服务运行后在TCP或UDP的某个端口侦听客户端的请求

用端口来定位服务，用ip地址来定位计算机

## TCP协议

- 点到点通讯：ip地址+端口=套接字


- 可靠传输：自动重传请求ARQ


- **停止等待协议**
  - 发送丢失：发送过程中如果报文出现丢失，发送端等待一个来回时间，没有收到确认消息则会重传，接收端丢弃不完整的包
  - 确认丢失：发送端等待一个来回时间，重传，接收端丢掉上一个报文
  - 确认迟到：后续收到确认消息，但是已经重传并且收到重传的确认消息，则什么也不做

- 窗口滑动：固定一个窗口大小进行传输，窗口内的数据可以发送和接收，如果最左边的收到ack，就窗口右移一位


- 累计确认：接收窗口只对收到的最后一个按顺序到达的字节进行确认
- 超时重传：TCP发送报文段会设置计时器，如果计时器重传时间到但是还没有收到确认，就重传

- 流量控制：接收端通过修改窗口大小来进行流量控制


- 网络拥塞控制
  - 慢开始
    - 从1，2，4个数据报开始尝试发送监测网络拥塞程度，到达慢开始门限之后开始每次+1进行尝试，直到丢包
    - 丢包后将慢开始门限设置为丢包时拥塞窗口值的1/2，再次重复上述机制
  - 快重传
  - 发送窗口应该选择接收方窗口和拥塞窗口中较小的一个MIn=[rwnd,cwnd]

## TCP传输连接管理

- 三次握手
  - A-B：建立连接，SYN=1，ACK=0，假设seq=x
  - B-A：回应，SYN=1，ACK=1，seq=y，ack=x+1
  - A-B：回应，ACK=1，seq=x+1，ack=y+1
- 第三次是为了防止失效的连接到达服务器，让服务器错误的打开新的连接
- 四次挥手
  - A-B：关闭连接请求，FIN=1，假设seq=u
  - B-A：关闭A-B的连接，ACK=1，seq=v，ack=u+1
  - B-A：传输完毕数据，关闭连接，FIN=1，ACK=1，seq=w，ack=v+1
  - A-B：同意关闭，ACK=1，seq=u+1，ack=w+1
- 第四次挥手等待2MSL为了处理B没收到A的第四次挥手而再次发送第三次挥手的数据报，并且可以确保数据报到达对面，下次建立连接不会存在旧的数据报